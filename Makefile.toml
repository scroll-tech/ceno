[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true
CORE = { script = ["grep ^cpu\\scores /proc/cpuinfo | uniq |  awk '{print $4}'"] }
RAYON_NUM_THREADS = "${CORE}"
CUR_TARGET = { script = [
        '''
        if [ -z "${TARGET}" ]; then
            TARGET=$(rustc -vV | grep "host" | awk '{print $2}')
            echo "${TARGET}"
        else
            echo "${TARGET}"
        fi
        '''
]}
TASK_RUN = { script = [
        '''
        #!/bin/bash
        exclude_projects=" singer-pro ceno_rt " # NOTE:keep leading and end with one space

        if echo "$exclude_projects" | grep -q -E "( )${CARGO_MAKE_CRATE_NAME}( )"; then
            echo "false"
        else
            echo "true"
        fi
        '''
]}

[tasks.tests]
condition = { env_true = ["TASK_RUN"] }
command = "cargo"
args = ["test", "--lib", "--release", "--target", "${CUR_TARGET}", "-p", "${CARGO_MAKE_CRATE_NAME}"]

[tasks.fmt-all-check]
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.fmt-all]
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy-all]
command = "cargo"
args = ["clippy", "--all-features", "--all-targets", "--", "-D", "warnings"]

[tasks.fmt]
command = "cargo"
args = ["fmt", "-p", "ceno_zkvm", "--", "--check"]

[tasks.clippy]
command = "cargo"
args = ["clippy", "-p", "ceno_zkvm", "-p", "mpcs", "-p", "ceno_emul", "-p", "ceno_rt", "--target", "${CUR_TARGET}", "--", "-D", "warnings"]
